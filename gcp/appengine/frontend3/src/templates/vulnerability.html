{% extends 'base.html' %}
{% set active_section = 'vulnerabilities' %}

{% block content %}
<div class="vulnerability-page">
<div class="mdc-layout-grid">
  <div class="mdc-layout-grid__inner">
    <div class="mdc-layout-grid__cell--span-12">
      <h1 class="title">{{ vulnerability.id }}</h1>
    </div>
    <div class="mdc-layout-grid__cell--span-12">
      <dl class="vulnerability-details">
        <dt>Source</dt>
        <dd><a href="{{ vulnerability.source_link }}">{{ vulnerability.source }}</a></dd>
        {% if vulnerability.aliases %}
          <dt>Aliases</dt>
          <dd>
            <ul class="aliases">
            {% for alias in vulnerability.aliases %}
              <li>
              {% if alias.exists -%}
                <a href="/vulnerability/{{ alias.alias_id }}">{{ alias.alias_id }}</a>
              {% else -%}
                {{ alias.alias_id }}
              {% endif %}
              {% if alias.same_alias_entries | length > 0 %}
                (
                {% for entry in alias.same_alias_entries %}
                  <a href="/vulnerability/{{ entry }}">{{ entry }}</a>{{ ',' if not loop.last }}
                {% endfor %}
                )
              {% endif %}
              </li>
            {% endfor %}
            </ul>
          </dd>
        {% endif %}
        <dt>Published</dt>
        <dd>{{ vulnerability.published }}</dd>
        <dt>Modified</dt>
        <dd>{{ vulnerability.modified }}</dd>
        <dt>Details</dt>
        <dd class="details">
          {{ vulnerability.details|markdown|safe }}
        </dd>
        <dt>References</dt>
        <dd>
          <ul class="links">
            {% for reference in vulnerability.references %}
              <li><a href="{{ reference['url'] }}">{{ reference['url'] }}</a></li>
            {% endfor %}
          </ul>
        </dd>
      </dl>
    </div>
  </div>
</div>
<div class="vulnerability-packages-container">
  <h2 class="title">Affected packages</h2>
  <spicy-sections
      class="vulnerability-packages{% if vulnerability.affected|should_collapse %} force-collapse{% endif %}">
    {% for affected in vulnerability.affected %}
      <h2 class="package-header">
        <span class="vuln-ecosystem spicy-sections-workaround">{{ affected['package']['ecosystem'] }}</span>
        <span class="vuln-title-divider spicy-sections-workaround">/</span>
        <span class="vuln-name spicy-sections-workaround">{{ affected['package']['name'] }}</span>
      </h2>
      <div class="mdc-layout-grid">
        <p class="subtitle">{{ affected['package']['name'] }}</p>
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Affected ranges
            <a href="https://ossf.github.io/osv-schema/#examples"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
            {% for range in affected['ranges'] %}
              <dl>
                <dt>Type</dt>
                <dd>{{ range['type'] }}</dd>
                <dt>Events</dt>
                <dd>
                  <div class="mdc-layout-grid__inner events">
                    {% for event in range['events'] %}
                      <div class="mdc-layout-grid__cell--span-3">
                        {{ event | event_type }}
                      </div>
                      <div class="mdc-layout-grid__cell--span-9 version-value">
                        {% set link = event | event_link %}
                        {% if link %}
                          <a href="{{ link }}"}>
                        {% endif %}

                        {{ event | event_value }}

                        {% if link %}
                          </a>
                        {% endif %}
                      </div>
                    {% endfor %}
                  </div>
                </dd>
              </dl>
            {% endfor %}
          </div>
        </div>
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Affected versions
            <a href="https://ossf.github.io/osv-schema/#affectedversions-field"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9 version-value">
            {% for group, versions in (affected['versions']|group_versions).items() %}
              <spicy-sections class="versions-section">
                <h2 class="version-header">{{ group }}</h2>
                <div class="versions {% if not loop.last %}versions-separator{% endif %}">
                  {% for version in versions %}
                    <div class="version">{{ version }}</div>
                  {% endfor %}
                </div>
              </spicy-sections>
            {% endfor %}
          </div>
        </div>
        {% if affected['ecosystem_specific'] %}
          <div class="vulnerability-package-subsection mdc-layout-grid__inner">
            <h3 class="mdc-layout-grid__cell--span-3">
              Ecosystem specific
              <a href="https://ossf.github.io/osv-schema/#affectedecosystem_specific-field"></a>
            </h3>
            <div class="mdc-layout-grid__cell--span-9">
              <pre class="specific">{{ affected['ecosystem_specific'] | display_json }}</pre>
            </div>
          </div>
        {% endif %}
        {% if affected['database_specific'] %}
          <div class="vulnerability-package-subsection mdc-layout-grid__inner">
            <h3 class="mdc-layout-grid__cell--span-3">
              Database specific
              <a href="https://ossf.github.io/osv-schema/#affectedrangesdatabase_specific-field"></a>
            </h3>
            <div class="mdc-layout-grid__cell--span-9">
              <pre class="specific">{{ affected['database_specific'] | display_json }}</pre>
            </div>
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </spicy-sections>
</div>
</div>
<turbo-stream action="update" target="title">
  <template>
    {{ vulnerability.id }} - OSV
  </template>
</turbo-stream>
{% endblock %}
