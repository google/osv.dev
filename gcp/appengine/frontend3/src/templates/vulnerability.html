{% extends 'base.html' -%}
{% set active_section = 'vulnerabilities' -%}

{% block extra_head %}
<link rel="preload" fetchpriority="high" as="image" href="/static/img/external-link.svg" type="image/webp">
{% endblock %}

{% block content -%}
<div class="vulnerability-page">
  <div class="mdc-layout-grid">
    <div class="mdc-layout-grid__inner">
      <div class="mdc-layout-grid__cell--span-12 vulnerability-title">
        <h1 class="title">
          {{ vulnerability.id }}
        </h1>
        {% if vulnerability.human_source_link and vulnerability.human_source_link.startswith("https://github.com/advisories/") -%}
          <a class="vulnerability-improvement-link" href="{{ vulnerability.human_source_link }}/improve">
            Suggest an improvement
          </a>
        {% else -%}
          <a class="vulnerability-improvement-link" href="https://google.github.io/osv.dev/faq/#ive-found-something-wrong-with-the-data">
            See a problem?
          </a>
        {% endif -%}
      </div>
      <div class="mdc-layout-grid__cell--span-12">
        <dl class="vulnerability-details">
          {%- if vulnerability.human_source_link -%}
          <dt>Source</dt>
          <dd><a href="{{ vulnerability.human_source_link }}" target="_blank" rel="noopener noreferrer">{{
              vulnerability.human_source_link }}</a>
          </dd>
          {%- endif -%}
          <dt>Import Source</dt>
          <dd><a href="{{ vulnerability.source_link }}" target="_blank" rel="noopener noreferrer">{{
              vulnerability.source }}</a></dd>
          
          <dt>JSON Data</dt>
          <dd><a href="https://{{ api_url }}/v1/vulns/{{ vulnerability.id }}" target="_blank" rel="noopener noreferrer">
            https://{{ api_url }}/v1/vulns/{{ vulnerability.id }}</a>
          </dd>
          {% if vulnerability.aliases -%}
          <dt>Aliases</dt>
          <dd>
            <ul class="aliases">
              {% for alias in vulnerability.aliases -%}
              <li>
                {% if alias | osv_has_vuln -%}
                <a href="/vulnerability/{{ alias }}">{{ alias }}</a>
                {% else -%}
                {{ alias }}
                {% endif -%}
              </li>
              {% endfor -%}
            </ul>
          </dd>
          {% endif -%}
          {% if vulnerability.related -%}
          <dt>Related</dt>
          <dd>
            <ul class="aliases expandible-list">
              {% for related in vulnerability.related -%}
              <li>
                {% if related | osv_has_vuln -%}
                <a href="/vulnerability/{{ related }}">{{ related }}</a>
                {% else -%}
                {{ related }}
                {% endif -%}
              </li>
              {% endfor -%}
            </ul>
          </dd>
          {% endif -%}
          {%- if vulnerability.withdrawn -%}
          <dt class="withdrawn">
            Withdrawn
            <a href="https://ossf.github.io/osv-schema/#withdrawn-field" target="_blank" rel="noopener noreferrer"></a>
          </dt>
          <dd class="withdrawn">{{ vulnerability.withdrawn }}</dd>
          {% endif -%}
          <dt>Published</dt>
          <dd>{{ vulnerability.published }}</dd>
          <dt>Modified</dt>
          <dd>{{ vulnerability.modified }}</dd>
          {%- if vulnerability.severity -%}
          <dt>Severity</dt>
          <dd>
            <ul class="severity">
              {% for item in vulnerability.severity -%}
              <li>{{ item.type }} - {{ item.score }}</li>
              {% endfor -%}
            </ul>
          </dd>
          {%- endif -%}
          <dt class="summary">Summary</dt>
          <dd class="summary {% if not vulnerability.summary %}muted{% endif %}">
            {% if vulnerability.summary %}
            {{ vulnerability.summary }}
            {% else %}
            [none]
            {% endif %}
          </dd>
          <dt>Details</dt>
          <dd class="details">
            {{ vulnerability.details|markdown|safe -}}
          </dd>
          <dt>References</dt>
          <dd>
            <ul class="links">
              {% for reference in vulnerability.references -%}
              <li><a href="{{ reference.url }}" target="_blank" rel="noopener noreferrer">{{ reference.url }}</a></li>
              {% endfor -%}
            </ul>
          </dd>
          {% if vulnerability.credits -%}
          <dt class="credits">Credits</dt>
          <dd class="credits">
            <ul>
              {% for credit in vulnerability.credits -%}
              <li class="credit">
                <ul>
                  <li>{{ credit.name }}{% if 'type' in credit %} - {{ credit.type }}{% endif %}</li>
                  {%- if 'contact' in credit -%}
                  <li>
                    <ul class="contact">
                      {%- for item in credit.contact -%}
                      <li><a href="{{ item }}" target="_blank" rel="noopener noreferrer">{{ item }}</a></li>
                      {%- endfor -%}
                    </ul>
                  </li>
                  {%- endif -%}
                </ul>
              </li>
              {% endfor -%}
            </ul>
          </dd>
          {% endif %}
        </dl>
      </div>
    </div>
  </div>
  <div class="vulnerability-packages-container">
    <h2 class="title">Affected packages</h2>
    <spicy-sections
      class="vulnerability-packages{% if vulnerability.affected|should_collapse %} force-collapse{% endif %}">
      {% for affected in vulnerability.affected -%}
      {% if 'package' in affected %}
      {% set ecosystem = affected.package.ecosystem %}
      {% set package = affected.package.name %}
      {% else %}
      {% set ecosystem = 'Git' %}
      {% if vulnerability.repo %}
      {% set package = vulnerability.repo | strip_scheme %}
      {% endif %}
      {% endif %}
      <h2 class="package-header">
        <span class="vuln-ecosystem spicy-sections-workaround">{{ ecosystem }}</span>
        <span class="vuln-title-divider spicy-sections-workaround">/</span>
        <span class="vuln-name spicy-sections-workaround">{{ package }}</span>
      </h2>
      <div class="mdc-layout-grid">
        {%- if 'package' in affected -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Package
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
            <dl>
              <dt>Name</dt>
              {%- if affected.package | package_in_ecosystem -%}
              <dd><a href="{{ affected.package | package_in_ecosystem }}" target="_blank" rel="noopener noreferrer">{{
                  affected.package.name }}</a></dd>
              {%- else -%}
              <dd>{{ affected.package.name }}</dd>
              {%- endif -%}
              {%- if ecosystem | has_link_to_deps_dev -%}
              <dd><a href="{{ package | link_to_deps_dev(ecosystem) }}" target="_blank" rel="noopener noreferrer">
                View open source insights on deps.dev</a></dd>
              {%- endif -%}
              {%- if 'purl' in affected.package -%}
              <dt>Purl</dt>
              <dd class="purl">{{ affected.package.purl }}</dd>
              {%- endif -%}
            </dl>
          </div>
        </div>
        {%- endif -%}
        {%- if 'severity' in affected -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Severity
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
            <ul class="severity">
              {% for item in affected.severity -%}
              <li>{{ item.type }} - {{ item.score }}</li>
              {% endfor -%}
            </ul>
          </div>
        </div>
        {%- endif -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Affected ranges
            <a href="https://ossf.github.io/osv-schema/#examples" target="_blank" rel="noopener noreferrer"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
          {% for range in affected.ranges -%}
            <dl>
              <dt>Type</dt>
              <dd>{{ range.type -}}</dd>

              {%- if range.repo -%}
              <dt>Repo</dt>
              <dd>{{ range.repo }}</dd>
              {%- endif -%}

              <dt>Events</dt>
              <dd>
                <div class="mdc-layout-grid__inner events">
                  {% for event in range.events -%}
                    <div class="mdc-layout-grid__cell--span-3">
                      {{ event | event_type -}}
                    </div>
                    <div class="mdc-layout-grid__cell--span-9 version-value">
                      {% set link = event | event_link -%}
                      {% if link -%}
                        <a href="{{ link }}">
                      {% elif event | event_type == 'Introduced' and event | event_value == '0' -%}
                        <div class="tooltip">
                      {% endif -%}

                      {{ event | event_value -}}

                      {% if link -%}
                        </a>
                      {% elif event.get('introduced') == '0' -%}
                        <span class="tooltiptext">The exact introduced commit is unknown</span>
                        </div>
                      {% endif -%}
                    </div>
                  {% endfor -%}
                </div>
              </dd>

              {%- if range.database_specific -%}
              <dt>
                Database specific
                <a href="https://ossf.github.io/osv-schema/#affectedrangesdatabase_specific-field" target="_blank"
                  rel="noopener noreferrer"></a>
              </dt>
              <dd><pre class="specific">{{ range.database_specific | display_json }}</pre></dd>
              {%- endif -%}
            </dl>
          {% endfor -%}
          </div>
        </div>
        {% if affected.versions -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Affected versions
            <a href="https://ossf.github.io/osv-schema/#affectedversions-field" target="_blank"
              rel="noopener noreferrer"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9 version-value">
            {% for group, versions in (affected.versions|group_versions(ecosystem)).items() -%}
            <spicy-sections class="versions-section">
              <h2 class="version-header">{{ group }}</h2>
              <div class="versions {% if not loop.last %}versions-separator{% endif %}">
                {% for version in versions -%}
                <div class="version">{{ version }}</div>
                {% endfor -%}
              </div>
            </spicy-sections>
            {% endfor -%}
          </div>
        </div>
        {% endif -%}
        {% if affected.ecosystem_specific -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Ecosystem specific
            <a href="https://ossf.github.io/osv-schema/#affectedecosystem_specific-field" target="_blank"
              rel="noopener noreferrer"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
            <pre class="specific">{{ affected.ecosystem_specific | display_json }}</pre>
          </div>
        </div>
        {% endif -%}
        {% if affected.database_specific -%}
        <div class="vulnerability-package-subsection mdc-layout-grid__inner">
          <h3 class="mdc-layout-grid__cell--span-3">
            Database specific
            <a href="https://ossf.github.io/osv-schema/#affecteddatabase_specific-field" target="_blank"
              rel="noopener noreferrer"></a>
          </h3>
          <div class="mdc-layout-grid__cell--span-9">
            <pre class="specific">{{ affected.database_specific | display_json }}</pre>
          </div>
        </div>
        {% endif -%}
      </div>
      {% endfor -%}
    </spicy-sections>
  </div>
</div>
<turbo-stream action="update" target="title">
  <template>
    {{ vulnerability.id }} - OSV
  </template>
</turbo-stream>

<script>
  document.addEventListener('turbo:load', function() {
    /*
    We use `spicy-section` to make the packages content collapsible for mobile view,
    but the issue is it collapse the content by default but we want to expaneded after
    the page is loaded. So we decide to programmatically click on header of collapsed
    packages after the page is loaded, and the content will be visible.
    */
    const package_headers = document.querySelectorAll('.package-header[affordance="collapse"][aria-expanded="false"]')
    package_headers.forEach((header) => {
      header.click()
    });

    /*
    Collapse fields if they have too many items. You can enable this feature by adding
    an 'expandible-list' class to lists with long value.
    */
    const EXPANDIBLE_LIST_DEFAULT_LENGTH = 5
    const expandible_lists = document.querySelectorAll('.expandible-list:not(expanded):not([data-has-toggle-btn])')
    expandible_lists.forEach((list) => {
      const items = list.getElementsByTagName('li')
  
      if (items.length <= EXPANDIBLE_LIST_DEFAULT_LENGTH) {
        return
      }
  
      const expandible_items = [...items].slice(EXPANDIBLE_LIST_DEFAULT_LENGTH)
      expandible_items.forEach((item)=>{
        item.style.display = 'none'
      });
      
      const toggle_button = document.createElement('span');
      toggle_button.classList.add('showmore');
      toggle_button.textContent = 'Show More';
      list.append(toggle_button)
      list.setAttribute("data-has-toggle-btn", true);
  
      toggle_button.addEventListener("click", function() {
        const is_expanded = list.classList.contains('expanded');
        expandible_items.forEach((item)=>{
          item.style.display = is_expanded ? 'none' : 'block'
        });
        toggle_button.textContent = is_expanded ? 'Show More' : 'Show Less'
        list.classList.toggle('expanded');
      });
    });
  });
</script>
{% endblock -%}