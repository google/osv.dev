# Converting NVD CVEs for open source software to OSV

Further context at [Introducing broad C/C++ vulnerability management support](https://osv.dev/blog/posts/introducing-broad-c-c++-support/)

See [run_cve_to_osv_generation.sh](https://github.com/google/osv.dev/blob/master/vulnfeeds/cmd/nvd-cve-osv/run_cve_to_osv_generation.sh) for how this is invoked in Production.

To see it in action on a single CVE:

```shell
CVE=CVE-2024-3094

git clone --recurse-submodules https://github.com/google/osv.dev

cd osv.dev/vulnfeeds

mkdir /tmp/nvd /tmp/nvd2osv

(cd test_data && ./download_specific_cves $CVE)
mv test_data/nvdcve-2.0/${CVE}.json /tmp/nvd
gcloud storage cp "gs://osv-test-cve-osv-conversion/cpe_repos/cpe_product_to_repo.json" "/tmp"

go run cmd/nvd-cve-osv/main.go \
    --cpe_repos "/tmp/cpe_product_to_repo.json" \
    --nvd_json "/tmp/nvd/${CVE}.json" \
    --out_dir "/tmp/nvd2osv"

cat /tmp/nvd2osv/*/*/${CVE}.json
```

# Conversion metric retrieval

This extracts the per-year metrics from the logs and presents them as a percentage over successful conversions from ones considered to be in scope (having a viable Git repository associated with them by CPE or by presence in a reference URL).

This requires at least these IAM roles:

- [Logs Viewer (`roles/logging-viewer`)](https://cloud.google.com/logging/docs/access-control#logging.viewer)
- [Service Usage Consumer (`roles/serviceusage.serviceUsageConsumer`)](https://cloud.google.com/iam/docs/understanding-roles#serviceusage.serviceUsageConsumer) (or [any other role](https://cloud.google.com/iam/docs/permissions-reference) granting the `serviceusage.services.use` permission)

For more information, see:

- [Cloud Logging CLI documentation](https://cloud.google.com/logging/docs/reference/tools/gcloud-logging)
- [Cloud Logging access control documentation](https://cloud.google.com/logging/docs/access-control)

```shell
$ gcloud --project oss-vdb logging read --freshness=12h --format=json 'logName="projects/oss-vdb/logs/nvd-cve-osv" "Metrics:"' | jq -r '. | map(.textPayload | gsub("[\\n]"; "")) | .[]' | awk '{
  match($1, /nvdcve-2\.0-(....)\.json/, year);
  match($5, /CVEsForKnownRepos:([0-9]+)/, cves_in_scope);
  match($6, /OSVRecordsGenerated:([0-9]+)/, osvs);
  print year[1], 100*osvs[1]/cves_in_scope[1]
}' | tail -n $[$(date +%Y) - 2016 + 1]
2016 81.6214
2017 77.1155
2018 64.1689
2019 71.334
2020 73.4837
2021 74.2835
2022 75.2699
2023 73.034
2024 52.2844
```

# Specific conversion treatment examination

## Prerequisites

- [Office Editing for Docs, Sheets & Slides](https://chromewebstore.google.com/detail/office-editing-for-docs-s/gbkeegbaiigmenfmjfclcdgdpimamgkj) (Please note: This extension is already installed on Chrome OS by default.)
- [JSON Formatter](https://chromewebstore.google.com/detail/json-formatter/gpmodmeblccallcadopbcoeoejepgpnb) for easier viewing of JSON output

## Process

### Retrieve latest per-year-per-record CSV report

1. Decide the year of NVD conversion data to review (2016 to the current year)
1. Visit [https://storage.googleapis.com/cve-osv-conversion/index.html?prefix=parts/nvd/nvd-conversion-outcomes-$YEAR](https://storage.googleapis.com/cve-osv-conversion/index.html?prefix=parts/nvd/nvd-conversion-outcomes-$YEAR) (for production) or [https://storage.googleapis.com/osv-test-cve-osv-conversion/index.html?prefix=parts/nvd/nvd-conversion-outcomes-$YEAR](https://storage.googleapis.com/osv-test-cve-osv-conversion/index.html?prefix=parts/nvd/nvd-conversion-outcomes-$YEAR) (for staging) based on the desired environment (note that this removes the prefixes of the filenames, making them look a bit weird).
1. Open the downloaded file. The CSV should open in a browser tab, but itâ€™s not really a Google Sheet (yet)

### Convert to a Google Sheet

1. `File > Save as Google Sheets`
1. At this point, it's now a bonafide Google Sheet in a new tab. You can close the previous tab.

- Consider renaming the Google Sheet to remove the `parts_nvd_` prefix that was added by the magic of the `index.html` JavaScript from step #2 in the previous section.

## Potential analyses

### General conversion metrics

- Create a pivot table to summarize a count of each outcome by outcome
  - Add a Row for outcome, sorted descending by COUNTA of outcome
  - Add a Values for outcome, summarized by COUNTA
- Interpretation
  - `Successful` is Successful
  - In-scope (i.e. attempted): is `NoRepos` + `Successful` + `FixUnresolvable` + `NoRanges`

### Record conversion failures with `NoRepos`

- Manually review the CVE record (particularly the references) for canonical software Git repository indications
- Manually review the existing [NVD CPE Dictionary](https://nvd.nist.gov/products/cpe) entry for canonical software Git repository indications
- [Review the logs](https://cloudlogging.app.goo.gl/o5hZGnH3km33enzH7) for the latest run of `cpe-repo-gen` and filter by the CPE Vendor and Product concatenated with a colon, e.g. `gnu:glibc`

### Record conversion failures with `NoRanges`

- Manually review the CVE record (particularly the description) for version hints
  - Desk check against the derived repository for resolvability to commits
    - `git ls-remote -t` or reviewing the repo in a browser
- Flag with the NVD (CVE Configuration Update Request) *and* the owning CNA
  - If the NVD fixes it first, great
  - If the CNA fixes it first, the update will trigger reeanalysis by the NVD

### Record conversion failures with `FixUnresolvable`

- Create a pivot table to look for any repository clustering that stands out
  - Add **repos** to Rows (order descending, sorted by COUNTA of repos), summarize by COUNTA and filter on the `FixUnresolvable` outcome
